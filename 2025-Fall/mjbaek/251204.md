# **Lactobacillus fermentum Pan-Genome & Functional COG Analysis**

## **Background**
*Lactobacillus fermentum*은 다양한 식품 발효 과정에 관여하는 대표적인 젖산균( LAB )으로, 탄수화물 대사·유기산 생성·내산성 등 발효 관련 특성을 보유한 균주이다.  
같은 종(*L. fermentum*) 내에서도 계통적 변이와 기능적 다양성이 존재할 수 있으며, 특히 **발효 대사 관련 유전자(탄수화물 분해·에너지 생산·스트레스 내성·산생성 등)** 의 차이는 발효 특성의 변화를 야기할 수 있다.

본 분석에서는 **ANI/AAI 기반 클러스터링을 통해 신뢰할 수 있는 동일 종 그룹을 확정한 뒤**,  
**Accessory gene 기능(특히 COG 카테고리) 분포가 클러스터 간 차이를 보이는지 통계적으로 탐색하는 것**을 목표로 하였다.

---

# **1. ANI·AAI 기반 품질 필터링 및 클러스터 안정화**

## **1.1 Pairwise Similarity Data Processing**
### **(1) 데이터 구조 정리**
- ANI / AAI 분석 결과를 모두 `GenomeA, GenomeB, Value` 형태의 pairwise 테이블로 변환.
- 대칭쌍(A–B, B–A) 제거 → 중복 없는 관계만 유지.

### **(2) 공통쌍 추출 & 병합**
- `pd.merge()`를 활용하여 **inner join**, 공통된 genome pair만 유지.
- 총 가능한 pair: **155개 genome → 11,935쌍**  
  - ANI: 11,935쌍  
  - AAI: 11,781쌍 (특정 FASTA 파일 오류로 일부 누락)

### **(3) ANI–AAI 불일치 탐지**
- `abs_diff = |ANI - AAI|`
- `flag = (ANI ≥ 95% and AAI < 95%) OR (ANI < 95% and AAI ≥ 95%)`
- 불일치 쌍만 추출하여 **low-consistency 그룹**으로 분리.

### **(4) Low-ANI Genome Detection and remove redundant entries**
- **AP017974.1**이 low-ANI pair에서 **308회 등장** → 구조적 변이 또는 다른 계통 가능성.
- 해당 ID 제외 + Complete chromosome 수준만 선별(NCBI에서 확보한 데이터는 CP033371.1, NZ_CP033371.1 이렇게 ID라벨링이 다르게 되어있음. CP만이 Complete chromosome 수준)→ **신뢰 가능한 genome set = 81개**

🔗 **Low-ANI pairs file:**  
`low_ani_outlier_pairs.csv`  
<https://github.com/igchoi/IBT610-CompGen/blob/c7f2158e09483995fcbe89c653a3632d4fc43d5f/2025-Fall/mjbaek/low_ani_outlier_pairs.csv>
**→ AP017974.1 제외 후 81개 genome을 pan-genome 분석에 사용.**

---
#**2. 해당 ID들을 기준으로 meta data ncbi에서 확보**


---

# **3. Pan-Genome Construction & Accessory Gene Annotation**

## **3.1 Genome Annotation**
- 81개 FASTA 파일을 **Prokka**로 annotation → `.gff` 파일 생성.

## **3.2 Pan-Genome Analysis (Roary)**
- 입력: 81개의 `.gff`  
- 출력:  
  - `gene_presence_absence.csv` (유전자 존재/부재 매트릭스)  
  - `clustered_proteins` 등  
- 확인 결과:  
  - **CP033371.1**이 다수 유전자에서 단독 결손 → outlier  
  - **CP033371.1은 downstream analysis에서 제외**

## **3.3 Accessory Gene Set 만들기**
- Roary matrix에서 **95% 미만 존재 빈도 (shell + cloud)** 유전자만 추출 →  
  **`accessory_genes.list` 생성**

## **3.4 EggNOG Functional Annotation 매핑**
- EggNOG 결과 파일 81개를 하나로 merge → `eggnog_all_merged.tsv`
- `accessory_genes.list` 기준으로 subset → `accessory_eggnog_annotations.tsv`

---

# **4. COG Functional Categorization**

## **왜 COG을 선택했는가?**
- KEGG Pathway 컬럼이 실제 metabolic pathway명을 포함하지 않는 경우가 많았음  
- KO/EC/Description만으로 발효 관련 효소를 자동 분류하기 어렵기 때문  
- COG은 기능별 카테고리화가 가장 잘 정리되어 있어 **클러스터 간 기능적 차이를 비교하기 최적**

## **처리 과정**
1. EggNOG 결과에서 COG category만 추출  
2. accessory gene presence/absence matrix와 merge  
3. genome별 COG category count 생성  
   → `genome_cog_category_counts.tsv`

---

# **5. Phylogenetic Analysis based on COG-C,E,G(fermentation related gene category)**

## **분석에서 핵심적으로 본 COG 카테고리**
- **C**: Energy production & conversion  
- **G**: Carbohydrate transport & metabolism  
- **E**: Amino acid transport & metabolism  
(발효 LAB 연구에서 가장 중요하게 다루는 기능 그룹)

## **Visualization with iTOL**
- Roary presence/absence matrix 기반으로 **accessory gene phylogeny (Newick)** 생성  
- COG category count + metadata를 iTOL annotation 파일로 변환  
- iTOL에서  
  1) **Accessory gene tree**  
  2) **COG C,G,E category bar**
  3) **meta data**
  를 함께 시각화하여 cluster별 기능적 차이 확인함

---

### Hypothesis
발효 관련 기능에 중요한 COG 카테고리(C, G, E)는  
**환경 기반 계통 구조(phylogroup)에 따라 유의적으로 차이가 난다**는 가설을 세웠다.

즉, **발효 적응성의 기능적 분화가 accessory gene 구성 차이로 나타날 것**이라는 예상이다.

*가설의 참고 근거
Li et al. (2024) -> 유산균(LAB)에서 발효 관련 기능이 accessory gene에 집중되어 있으며, 계통에 따라 다르게 분포함.

Mejía-Caballero et al. (2025) -> 1020개 Lactobacillus 균주를 대상으로 환경 기반 계통과 기능적 적응 분석. 계통에 따라 환경 적응 관련 유전자(발효, 대사 등)가 다르게 나타남.

---

## 7. Phylogroup Construction (H35 Cut)

### 7.1 Why H35?
Roary accessory gene matrix 기반 phylogeny를 height로 클러스터링했을 때:

- H20 이하 → 과도하게 세분화
- H45~H50 → 과하게 병합
- **H35 → 계통적/기능적 패턴이 가장 일관적이며 5개 phylogroup으로 안정적 분리됨**

결과 파일: **`phylogroup_h35.tsv`**

---

## 8. Statistical Tests for Functional Differences (C/G/E)

### 8.1 Why Chi-square?
- 비교: **group-level C/G/E 총량**
- 목적: 기능적 풍부도 차이 평가
- 카운트 기반 비율 비교 → 카이제곱 적합

### 8.2 Why Kruskal–Wallis?
- 비교: **strain-level 분포 차이**
- 데이터가 비정규/이산적 카운트 → 비모수 검정 필요

---

## 9. Results — Chi-square & Kruskal–Wallis

### 9.1 Chi-square (총량 차이)
- **C:** p ≈ 1.2e⁻²⁷⁶  
- **G:** p ≈ 5.1e⁻²¹⁷  
- **E:** p → 1e⁻(수십) 수준
- 
<img width="1200" height="1800" alt="cog_group_counts_h35_heatmap" src="https://github.com/user-attachments/assets/11df12a5-02e0-4c34-96f2-25c665d3174e" />


→ **세 기능 모두 phylogroup 간 총량 차이가 극도로 유의함.**



### 9.2 Kruskal–Wallis (strain-level)
- **C:** p ≈ 6.4e⁻⁶  
- **G:** p ≈ 3.6e⁻⁵  
- **E:** p ≈ 3.7e⁻¹¹  

<img width="2400" height="1200" alt="cog_CGE_h35_boxplot_smallfliers" src="https://github.com/user-attachments/assets/ec6d3663-d69c-4e09-b6bb-3887540719b2" />


→ **각 genome이 가진 C/G/E 구성도 그룹 간 차이가 명확함.**

---

## 10. Accessory Genome Size Adjustment

앞선 분석은 절대 C/G/E 개수 차이에 대한 것이며,  
이 질문이 남는다:

> **전체 accessory gene 수를 보정해도 C/G/E 비율 차이가 유지되는가?**

### 10.1 Input files
- `accessory_gene_counts_95cutoff_geneID.tsv`  
  → strain별 total accessory gene count  
- `cog_by_strain_CGE_h35_no_CP033371.tsv`  
  → strain별 C/G/E functional gene count  

두 파일을 strain 기준으로 merge하여  
**CGE / accessory 비율**을 계산.

---

## 11. Fisher’s Exact Test (Proportion-Based Analysis)

### 11.1 Why Fisher?
- 그룹 간 accessory 규모가 다름  
- 비율 기반 카운트  
- 작은 count 존재 → Chi-square보다 정확도 높음  

---

### 11.2 Results
<img width="1560" height="960" alt="fisher_CGE_enrichment_h35_barplot" src="https://github.com/user-attachments/assets/3875f7d2-d84f-439a-81c5-177da81f55e6" />


| Group | Odds Ratio | p-value | Interpretation |
|-------|------------|---------|----------------|
| **1** | 1.297 | 4.9e⁻20 | CGE 비율 **높음 (enriched)** |
| **2** | 0.813 | 1.1e⁻8 | **낮음 (depleted)** |
| **3** | 1.050 | 0.254 | 차이 없음 |
| **4** | 0.837 | 2.8e⁻4 | **낮음** |
| **5** | 0.853 | 4.9e⁻3 | **낮음** |

### Interpretation
- **Group 1 → 발효 관련 기능이 강화된(enriched) phylogroup**  
- **Group 2, 4, 5 → 기능적으로 감소(depleted)**  
- **Group 3 → 중립적 그룹**  

→ accessory genome 크기를 보정해도 **기능 차이는 유지됨**.

---




