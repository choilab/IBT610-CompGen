# **Lactobacillus fermentum Pan-Genome Analysis Report**

## **Title**

**Construction of *Lactobacillus fermentum* phylogroup Based on Accessory Gene Clustering**

---
## **Background**

Lactobacillus fermentum은 유산균(Lactic Acid Bacteria, LAB) 계열에 속하는 그람양성 혐기성/통성혐기성 박테리아로, 다양한 발효식품(치즈, 김치, 요구르트 등)과 인간 및 동물의 점막(위장관, 구강, 비뇨생식계)에서 흔히 분리된다. 본 종은 다음과 같은 특성과 연구적/산업적 가치를 지닌다:

* **생태·응용적 중요성**: 전통 발효식품의 핵심 구성 미생물 중 하나로서 발효 특성, 유기산(주로 젖산) 생성, 엑소다당류(예: EPS) 생성, 그리고 항균물질(박테리오신) 합성 등으로 식품 품질 및 보존성에 영향을 준다.
* **프로바이오틱 잠재력**: 장벽 강화, 병원성 억제 및 면역조절과 관련한 여러 연구에서 프로바이오틱 특성이 보고되었다.
* **유전체 크기 및 유전정보**: 공개된 L. fermentum 완전체/초안 유전체의 평균 크기는 약 **~1.9–2.1 Mbp** 범위, 평균 CDS(예상 단백질 코딩 유전자) 수는 연구별로 **약 1,800–2,100개** 수준으로 보고된다. 
* **유전적 다양성의 의미**: L. fermentum은 분리원(치즈, 발효채소, 유제품, 사람 유래 등)에 따라 accessory genome에서 큰 차이를 보이는 경향이 있어(Zhao, Yan, et al.2022), accessory genome에 대한 분석이 중요하다.
  
---
## **Objective**
본 프로젝트의 목적은 80개의 *Lactobacillus fermentum* 전체 유전체 데이터를 기반으로 **pan-genome 분석**을 수행하고, **accessory gene 기반의 클러스터링을 통해 phylogroup(H35)을 나누고, 각 그룹이 **발효 관련 기능(C/G/E)** 관점에서 서로 다른 유전자 패턴을 가지는지 평가**하는 것이다.

---

# **1. ANI·AAI 기반 품질 필터링 및 클러스터 안정화**

## **1.1 Pairwise Similarity Data Processing**
### **(1) 데이터 구조 정리**
- ANI / AAI 분석 결과를 모두 `GenomeA, GenomeB, Value` 형태의 pairwise 테이블로 변환.
- 대칭쌍(A–B, B–A) 제거 → 중복 없는 관계만 유지.

### **(2) 공통쌍 추출 & 병합**
- `pd.merge()`를 활용하여 **inner join**, 공통된 genome pair만 유지.
- 총 가능한 pair: **155개 genome → 11,935쌍**  
  - ANI: 11,935쌍
  - <img width="3600" height="3000" alt="ani_heatmap" src="https://github.com/user-attachments/assets/b0c50b30-4dc0-4a43-bf48-aa3a7826301f" /> (모든 ID가 HEAT MAP에 표시되진 않음.)

### **(3) Low-ANI Genome Detection and remove redundant entries**
- **AP017974.1**이 low-ANI pair에서 **308회 등장** → 구조적 변이 또는 다른 계통 가능성.
- 해당 ID 제외 + 대칭쌍(A–B, B–A) 제거 + Complete chromosome 수준만 선별→ **신뢰 가능한 genome set = 81개**

### **(4) 해당 ID들을 기준으로 meta data ncbi에서 확보**
<https://github.com/minjBaek02/file_collection/blob/7fbeae435665bb2e288639ce7ee23774b7632475/%EA%B9%83%ED%97%88%EB%B8%8C%20%EC%97%85%EB%A1%9C%EB%93%9C%20%ED%8C%8C%EC%9D%BC/biosample_metadata_81_sort.csv>


---

# **2. Pan-Genome Construction & Accessory Gene Annotation**

## **2.1 Genome Annotation**
- 81개 FASTA 파일을 **Prokka**로 annotation → `.gff` 파일 생성.

## **2.2 Pan-Genome Analysis (Roary)**
- 입력: 81개의 `.gff`  
- 출력:  
  - `gene_presence_absence.csv` (유전자 존재/부재 매트릭스)  
  - `clustered_proteins` 등  
- 확인 결과:  
  - **CP033371.1**이 다수 유전자에서 단독 결손 → outlier  
  - **CP033371.1은 downstream analysis에서 제외**

## **2.3 Accessory Gene Set 만들기**
- Roary matrix에서 **95% 미만 존재 빈도 (shell + cloud)** 유전자만 추출 →  
  **`accessory_genes.list` 생성**

## **2.4 EggNOG Functional Annotation 매핑**
- EggNOG 결과 파일 81개를 하나로 merge → `eggnog_all_merged.tsv`
- `accessory_genes.list` 기준으로 subset → `accessory_eggnog_annotations.tsv`

---

# **3. COG Functional Categorization**

## **왜 COG을 선택했는가?**
- KEGG Pathway 컬럼이 실제 metabolic pathway명을 포함하지 않는 경우가 많았음  
- KO/EC/Description만으로 발효 관련 효소를 자동 분류하기 어렵기 때문  
- COG은 기능별 카테고리화가 가장 잘 정리되어 있어 **클러스터 간 기능적 차이를 비교하기 최적**

## **처리 과정**
1. EggNOG 결과에서 COG category만 추출  
2. accessory gene presence/absence matrix와 merge  
3. genome별 COG category count 생성  
   → `genome_cog_category_counts.tsv`

---

# **4. Phylogenetic Analysis based on COG-C,E,G(fermentation related gene category)**

## **분석에서 핵심적으로 본 COG 카테고리**
- **C**: Energy production & conversion  
- **G**: Carbohydrate transport & metabolism  
- **E**: Amino acid transport & metabolism  
(발효 LAB 연구에서 가장 중요하게 다루는 기능 그룹)

## **Visualization with iTOL**
- Roary presence/absence matrix 기반으로 **accessory gene phylogeny (Newick)** 생성  
- COG category count + metadata를 iTOL annotation 파일로 변환  
- iTOL에서  
  1) **Accessory gene tree**  
  2) **COG C,G,E category bar**
  3) **meta data**
  를 함께 시각화하여 cluster별 기능적 차이 확인함
<img width="1216" height="685" alt="image" src="https://github.com/user-attachments/assets/468faa9b-fea9-4144-a782-66f76b0f0123" />

---
(1204) 
### Hypothesis 1
발효 관련 기능에 중요한 COG 카테고리(C, G, E)는 **phylogroup에 따라 유의적으로 차이가 난다**는 가설을 세웠다.

즉, **발효 적응성의 기능적 분화가 accessory gene 구성 차이로 나타날 것**이라는 예상이다.

**가설의 참고 근거**
- Li et al. (2024) -> 유산균(LAB)에서 발효 관련 기능이 accessory gene에 집중되어 있으며, 계통에 따라 다르게 분포함.
- Mejía-Caballero et al. (2025) -> 1020개 Lactobacillus 균주를 대상으로 환경 기반 계통과 기능적 적응 분석. 계통에 따라 환경 적응 관련 유전자(발효, 대사 등)가 다르게 나타남.

---

## 5. Phylogroup Construction (H35 Cut)
서로 유전적으로 어느 정도 이상 가까운 균주끼리 한 그룹으로 묶고, 각 그룹을 서로 통계적으로 분석하기 위해 기준 거리 0.35을 기준으로 자름.

### 5.1 Why H35?
Roary accessory gene matrix 기반 phylogeny를 height로 클러스터링했을 때:

- H20 이하 → 과도하게 세분화
- H45~H50 → 과하게 병합
- **H35 → 계통적/기능적 패턴이 가장 일관적이며 5개 phylogroup으로 안정적 분리됨**

결과 파일: **`phylogroup_h35.tsv`**
<img width="1016" height="794" alt="image" src="https://github.com/user-attachments/assets/060e413d-7b9e-4ad7-8533-58a0367bd9be" />

---

## 6. 그룹별 유전자 수 유의차의 검정 Chi-square & Kruskal–Wallis

### 6.1 Chi-square 
**무엇을 비교?**  
- 각 COG category(C, G, E)의 **total gene counts**(그룹 전체 합계)를 이용해  
- phylogroup × category로 이루어진 **contingency table**의 분포 차이를 확인.
  
1. input file은 모든 strain의 phylogroup을 나눈 정보를 포함해 cog결과에서 c,g,e를 카운팅해서 추출. cog_by_strain_CGE_h35_no_CP033371.tsv

2. 전체 C 카테고리 유전자 총합이 A일 때, “만약 그룹 차이가 없다면” → A를 그룹들의 규모(예: strain 수, 전체 gene 수 등)에 따라 **비례적으로 나눴을 때의 기대값(expected)**을 계산한다.

3. Chi-square 통계량 계산

4. 해석:
- 관측과 기대가 **비슷하면** → χ² 작음 → p값 큼 → 차이 없음  
- 관측과 기대가 **크게 다르면** → χ² 큼 → p값 작음 → 차이 있음

이 과정을  
**C / G / E 각각에 대해 독립적으로 수행**하였다.

- **C:** p ≈ 1.2e⁻²⁷⁶  
- **G:** p ≈ 5.1e⁻²¹⁷  
- **E:** p → 1e⁻(수십) 수준
- 아래는 각 그룹에서 해당 chi-square 결과, 어느 phylogroup이 C/G/E를 많이/적게 가지는지 heatmap으로 표현했다.
  
<img width="1000" height="1800" alt="cog_group_counts_h35_heatmap" src="https://github.com/user-attachments/assets/11df12a5-02e0-4c34-96f2-25c665d3174e" />


→ **세 기능 모두 phylogroup 간 총량 차이가 유의함.**



### 6.2 Kruskal–Wallis 
**무엇을 비교?**  
- 각 strain(개별 genome)이 가진 **COG count distribution**  
  - 예: 한 genome이 가진 COG C 유전자 수  
- 이 값이 phylogroup 간 동일한 분포인지 확인

1. input file은 모든 strain의 phylogroup을 나눈 정보를 포함해 cog결과에서 c,g,e를 카운팅해서 추출. cog_by_strain_CGE_h35_no_CP033371.tsv
- 모든 strain의 C,G,E_count를 한 줄로 모아서 → 값이 작은 것부터 큰 것까지 **순위(rank)**를 매김.

3. phylogroup별로 “순위들의 합”을 계산
어떤 그룹은 순위가 큰 값 쪽에 몰려 있고, 어떤 그룹은 작은 값 쪽에 몰려 있으면 → 그룹 간 차이가 큰 것.

4. 이 “랭크 합 차이”가 “우연이어도 이 정도는 나올 법 하다” → p값 큼. “우연으로는 거의 안 나온다” → p값 작음

- **C:** p ≈ 6.4e⁻⁶  
- **G:** p ≈ 3.6e⁻⁵  
- **E:** p ≈ 3.7e⁻¹¹
- 그리고 아래는 어떤 phylogroup에서 C/G/E가 평균적으로 더 높은지/낮은지 boxplot으로 나타냈다. (dot은 통계에서 튀는 값이다.)

<img width="2400" height="1200" alt="cog_CGE_h35_boxplot_smallfliers" src="https://github.com/user-attachments/assets/ec6d3663-d69c-4e09-b6bb-3887540719b2" />


→ **각 genome이 가진 C/G/E 구성도 그룹 간 차이가 명확함.**
→ C, G, E 유전자 수를 strain 단위로 봤을 때, 다섯 phylogroup의 C,G,E 카테고리 유전자 분포는 다르다. 


---

## Hypothesis 2

앞선 분석은 절대 C/G/E 개수 차이에 대한 것이며,  
이 질문이 남는다:

> **전체 accessory gene 수를 보정해도 C/G/E 비율 차이가 유지되는가?**


---

## 7. Fisher’s Exact Test (Proportion-Based Analysis)

본 분석에서는 accessory gene 중 발효 관련 핵심 기능군(COG C, G, E)을 합산한 **CGE count**가  
각 phylogroup(H35 기준)에서 **특정 그룹에서 특이적으로 높거나 낮은지**를 확인하기 위해 수행함.


## 7.1 work flow
1. **Accessory gene count 파일**과 **strain별 C/G/E count 파일**을  
   **strain 이름 기준으로 merge**
- `accessory_gene_counts_95cutoff_geneID.tsv`  
  → strain별 total accessory gene count
- `cog_by_strain_CGE_h35_no_CP033371.tsv`  
  → strain별 C/G/E functional gene count  

3. 각 strain에 대해  
   - accessory gene total  
   - C, G, E count  
   을 모두 포함하는 dataset 구축

4. C, G, E를 합쳐  
   **CGE = C + G + E**

5. 모든 strain을 H35 기준 phylogroup 5개로 분류

6. 각 phylogroup별로 다음 값을 계산:
   - 그룹 내 CGE 유전자 수 합
   - 그룹 내 accessory 유전자 수 합

7. 각 그룹에 대해 다음 2×2 contingency table 구성:

|                | CGE genes | non-CGE accessory |
|----------------|-----------|-------------------|
| this group     | a         | b                 |
| all other grps | c         | d                 |


위 테이블을 기반으로 **Fisher’s exact test** 수행  → “이 그룹의 CGE 비율이 나머지보다 높은가/낮은가”를 검정
   
---

### 7.2 Results
<img width="1560" height="960" alt="fisher_CGE_enrichment_h35_barplot" src="https://github.com/user-attachments/assets/3875f7d2-d84f-439a-81c5-177da81f55e6" />


| Group | Odds Ratio | p-value | Interpretation |
|-------|------------|---------|----------------|
| **1** | 1.297 | 4.9e⁻20 | CGE 비율 **높음 (enriched)** |
| **2** | 0.813 | 1.1e⁻8 | **낮음 (depleted)** |
| **3** | 1.050 | 0.254 | 차이 없음 |
| **4** | 0.837 | 2.8e⁻4 | **낮음** |
| **5** | 0.853 | 4.9e⁻3 | **낮음** |

### 8. Interpretation and summary
- **Group 1 → 발효 관련 기능이 강화된(enriched) phylogroup**  
- **Group 2, 4, 5 → 기능적으로 부족한 편(depleted)**  
- **Group 3 → 중립적 그룹**  
→ accessory genome 크기를 보정해도 **발효 관련 유전자 수의 차이는 유지됨**.

-total summary

"Is the hypothesis validated by the analyses?"
→ Accessory genome의 구조적 다양성(0.35 distance cutoff로 분리된 phylogroup)은 발효 적응성(energy metabolism, carbohydrate metabolism, amino acid metabolism)을 대표하는 COG C/G/E의 분포 차이와 연관된다.


### 9. 추후 분석
🔹 IDEA: C/G/E + M 카테고리 기반 “발효 적합 균주” 선별
1. 관찰한 내용
-Group 1은 C/G/E(발효 관련) 유전자가 유의하게 가장 풍부함. COG 카테고리 중 M은 세포 표면·막 구조(M 카테고리: cell wall/envelope) 의미.

2. 아이디어
-발효 적응에는 대사(CGE) 뿐 아니라 세포표면/막(M) 카테고리의 유전자들 역시 생존·부착·스트레스 내성에 있어 중요하다.
-따라서, C/G/E가 많고 M도 많은 균주는 발효 환경에서 더 적합할 것이다. → 두 기능군을 결합해 “발효 유망 균주”를 정의.

3. 분석 방향 제안
-Group1의 M 유전자 수/비율도 동일한 방식으로 비교.
-C/G/E와 M을 각각 -> Kruskal–Wallis (그룹 차이), Fisher’s test (비율 차이)로 평가.
-두 기능군을 합친 간단한 점수(CGE_high + M_high)로발효 적합 후보군을 선별.

---


### files
-phylogroup_h35.tsv
<https://github.com/minjBaek02/file_collection/blob/c11e6023b293fcfb4f63a47085f614620f4ded9c/%EA%B9%83%ED%97%88%EB%B8%8C%20%EC%97%85%EB%A1%9C%EB%93%9C%20%ED%8C%8C%EC%9D%BC/phylogroup_h35.tsv>

-cog_by_strain_CGE_h35_no_CP033371.tsv
<https://github.com/minjBaek02/file_collection/blob/c11e6023b293fcfb4f63a47085f614620f4ded9c/%EA%B9%83%ED%97%88%EB%B8%8C%20%EC%97%85%EB%A1%9C%EB%93%9C%20%ED%8C%8C%EC%9D%BC/cog_by_strain_CGE_h35_no_CP033371.tsv>

-accessory_gene_counts_95cutoff_geneID.tsv
<https://github.com/minjBaek02/file_collection/blob/c11e6023b293fcfb4f63a47085f614620f4ded9c/%EA%B9%83%ED%97%88%EB%B8%8C%20%EC%97%85%EB%A1%9C%EB%93%9C%20%ED%8C%8C%EC%9D%BC/accessory_gene_counts_95cutoff_geneID.tsv>

---




